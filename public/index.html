<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Создать Валентинку</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @font-face {
            font-family: "ALS Hauss Medium";
            src: url("https://db.onlinewebfonts.com/t/af2bba52a607a39b7b92a72428ff47ca.eot");
            src: url("https://db.onlinewebfonts.com/t/af2bba52a607a39b7b92a72428ff47ca.eot?#iefix")format("embedded-opentype"),
                url("https://db.onlinewebfonts.com/t/af2bba52a607a39b7b92a72428ff47ca.woff2")format("woff2"),
                url("https://db.onlinewebfonts.com/t/af2bba52a607a39b7b92a72428ff47ca.woff")format("woff"),
                url("https://db.onlinewebfonts.com/t/af2bba52a607a39b7b92a72428ff47ca.ttf")format("truetype"),
                url("https://db.onlinewebfonts.com/t/af2bba52a607a39b7b92a72428ff47ca.svg#ALS Hauss Medium")format("svg");
        }


        body {
            margin: 0;
            padding: 20px;
            font-family: "ALS Hauss Medium";
            background: #000;
            color: #ff7a00;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            width: 100%;
            background: #000000;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        h1 {
            color: #fff;
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            font-size: 18px;
            margin: 10px 0;
            border-radius: 10px;
            background: #222;
            color: #fff;
            resize: none;
        }

        canvas {
            max-width: 100%;
            margin: 10px 0;
            border-radius: 10px;
        }

        button {
            width: 100%;
            padding: 20px;
            font-size: 20px;
            margin: 5px;
            background: #fd5300;
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        .telegram {
            background-color: #0088cc;
            color: #fff;
        }

        button:hover {
            background: #fff;
            color: #000;
        }

        #buttons {
            display: none;
            margin-top: 15px;
        }

        .loading {
            display: none;
            color: #ff7a00;
            font-style: italic;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Николай Иронов создаст валентинку с пожеланиями</h1>

        <textarea id="message" placeholder="Введите пожелание...">С Днём Святого Валентина!
Любви и счастья!</textarea>

        <button onclick="generateValentine()">Сгенерировать</button>

        <canvas id="valentineCanvas" width="300" height="300"></canvas>

        <div class="loading" id="loading">Загружаем на сервер...</div>

        <div id="buttons">
            <button onclick="downloadValentine()">Скачать</button>
            <button class="telegram" onclick="shareToTelegram()">Поделиться через Telegram</button>
        </div>
    </div>

    <script>
        let currentImageUrl = null;
        let currentImageId = null;
        function generateValentine() {
            const canvas = document.getElementById('valentineCanvas');
            const ctx = canvas.getContext('2d');
            const text = document.getElementById('message').value;

            ctx.clearRect(0, 0, 500, 500);

            // Фон градиент нежно-розовый
            const gradient = ctx.createLinearGradient(0, 0, 500, 500);
            gradient.addColorStop(0, '#ffe6f0');
            gradient.addColorStop(1, '#ffccd9');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 500, 500);

            // Генерация сердечек разного размера, цвета и формы
            const hearts = [
                { x: 250, y: 200, size: 50, color: '#ff99c8' },
                { x: 100, y: 100, size: 20, color: '#ffb3d1' },
                { x: 400, y: 100, size: 25, color: '#ff80aa' },
                { x: 100, y: 400, size: 15, color: '#ffc0d8' },
                { x: 400, y: 400, size: 30, color: '#ff99c8' },
                { x: 250, y: 50, size: 10, color: '#ffd6e8' }, // маленькие
                { x: 50, y: 250, size: 15, color: '#ffb3d1' },
                { x: 450, y: 250, size: 15, color: '#ff80aa' },
            ];

            hearts.forEach(h => {
                ctx.fillStyle = h.color;
                drawHeart(ctx, h.x, h.y, h.size);
            });

            // Текст
            ctx.fillStyle = '#d6336c';
            ctx.font = 'bold 20px Roboto';
            ctx.textAlign = 'center';
            ctx.globalAlpha = 1;

            const lines = text.split('\n');
            lines.forEach((line, i) => {
                ctx.fillText(line, 250, 300 + i * 30);
            });

            ctx.font = 'italic 16px Roboto';
            ctx.fillText('С любовью', 250, 470);

            uploadToServer();
        }

        function drawHeart(ctx, x, y, size) {
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.bezierCurveTo(x - size / 2, y - size, x - size, y - size / 3, x, y + size / 2);
            ctx.bezierCurveTo(x + size, y - size / 3, x + size / 2, y - size, x, y);
            ctx.fill();
        }

        async function uploadToServer() {
            const canvas = document.getElementById('valentineCanvas');
            const loading = document.getElementById('loading');
            const buttons = document.getElementById('buttons');

            loading.style.display = 'block';
            buttons.style.display = 'none';

            try {
                canvas.toBlob(async (blob) => {
                    const formData = new FormData();
                    formData.append('image', blob, 'valentine.png');

                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        currentImageUrl = data.url;
                        currentImageId = data.id;
                        loading.style.display = 'none';
                        buttons.style.display = 'flex';
                        console.log('Картинка загружена:', data.url);
                    } else {
                        loading.style.display = 'none';
                        console.error('Ошибка сохранения:', data.error);
                    }
                }, 'image/png');
            } catch (error) {
                loading.style.display = 'none';
                console.error('Ошибка сети:', error);
            }
        }

        function downloadValentine() {
            const canvas = document.getElementById('valentineCanvas');
            const link = document.createElement('a');
            link.download = 'валентинка.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function shareToTelegram() {
            if (!currentImageUrl) return;
            const messageText = "Вам отправили валентинку!\nНажмите на ссылку, чтобы увидеть.";
            const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(currentImageUrl)}&text=${encodeURIComponent(messageText)}`;
            window.open(telegramUrl, '_blank');
        }

        window.onload = generateValentine;
    </script>
</body>

</html>